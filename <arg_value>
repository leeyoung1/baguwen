#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æµ‹è¯•ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶åŠ è½½
"""

import os
import time
import threading
import webbrowser
from http.server import SimpleHTTPRequestHandler
from socketserver import TCPServer
from urllib.parse import quote, unquote

def test_special_chars():
    """æµ‹è¯•ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶"""
    base_dir = "/Users/liyang/Desktop/03-å­¦ä¹ èµ„æ–™/holliså…«è‚¡æ–‡(1)"

    # æµ‹è¯•åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡ä»¶
    test_files = [
        "JavaåŸºç¡€/BigDecimal(double)å’ŒBigDecimal(String)æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ.md",
        "æ•°æ®ç»“æ„/æ•°ç»„å’Œé“¾è¡¨æœ‰ä½•åŒºåˆ«ï¼Ÿ.md",
        "æ•°æ®ç»“æ„/ä»€ä¹ˆæ˜¯å°é¡¶å †ï¼Œå¯ä»¥ç”¨åœ¨å“ªäº›åœºæ™¯ï¼Ÿ.md",
        "æ•°æ®ç»“æ„/ä»€ä¹ˆæ˜¯B+æ ‘ï¼Œå’ŒBæ ‘æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ.md",
        "JavaåŸºç¡€/å¦‚ä½•ç†è§£Javaä¸­çš„å¤šæ€ï¼Ÿ.md"
    ]

    print("ğŸ§ª æµ‹è¯•ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶")
    print("=" * 50)

    for i, file_path in enumerate(test_files, 1):
        print(f"{i}. {file_path}")

        full_path = os.path.join(base_dir, file_path)
        if os.path.exists(full_path):
            print(f"   âœ… æ–‡ä»¶å­˜åœ¨")

            # æµ‹è¯•URLç¼–ç 
            encoded = quote(file_path)
            print(f"   ğŸ”— URLç¼–ç : {encoded[:50]}...")

            # æµ‹è¯•è§£ç 
            decoded = unquote(encoded)
            print(f"   ğŸ”“ URLè§£ç : {decoded}")

            # æ£€æŸ¥ç¼–ç æ˜¯å¦æ­£ç¡®
            if decoded == file_path:
                print(f"   âœ… ç¼–ç /è§£ç æ­£ç¡®")
            else:
                print(f"   âŒ ç¼–ç /è§£ç é”™è¯¯")
        else:
            print(f"   âŒ æ–‡ä»¶ä¸å­˜åœ¨")
        print()

    # å¯åŠ¨æœåŠ¡å™¨è¿›è¡Œå®é™…æµ‹è¯•
    print("ğŸš€ å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨è¿›è¡Œå®é™…åŠ è½½æµ‹è¯•...")
    print("=" * 50)

    port = 8003
    os.chdir(base_dir)

    class QuietHandler(SimpleHTTPRequestHandler):
        def log_message(self, format, *args):
            pass

    try:
        with TCPServer(("", port), QuietHandler) as httpd:
            print(f"âœ… æµ‹è¯•æœåŠ¡å™¨å·²å¯åŠ¨: http://localhost:{port}")
            print("ğŸ“– ç°åœ¨å¯ä»¥æµ‹è¯•ä»¥ä¸‹åŠŸèƒ½:")
            print("   1. ä¸»é¡µé¢åŠ è½½")
            print("   2. æ–‡æ¡£ç´¢å¼•è§£æ")
            print("   3. ç‰¹æ®Šå­—ç¬¦æ–‡æ¡£è®¿é—®")
            print("   4. é”™è¯¯å¤„ç†å’Œè°ƒè¯•ä¿¡æ¯")
            print()
            print("â³ 3ç§’åè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨...")

            def delayed_open():
                time.sleep(3)
                try:
                    webbrowser.open(f'http://localhost:{port}')
                    print("ğŸŒ æµè§ˆå™¨å·²æ‰“å¼€ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•äº†")
                except:
                    print("âŒ æ— æ³•è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¯·æ‰‹åŠ¨è®¿é—®")

            browser_thread = threading.Thread(target=delayed_open)
            browser_thread.daemon = True
            browser_thread.start()

            print("ğŸ”„ æœåŠ¡å™¨è¿è¡Œä¸­... (15ç§’åè‡ªåŠ¨åœæ­¢)")

            # è¿è¡Œ15ç§’ååœæ­¢
            def auto_stop():
                time.sleep(15)
                print("\nğŸ›‘ æµ‹è¯•å®Œæˆ")
                httpd.shutdown()

            stop_thread = threading.Thread(target=auto_stop)
            stop_thread.daemon = True
            stop_thread.start()

            httpd.serve_forever()

    except OSError as e:
        print(f"âŒ ç«¯å£ {port} è¢«å ç”¨")
        return False
    except KeyboardInterrupt:
        print("\nğŸ‘‹ æµ‹è¯•å·²åœæ­¢")
        return False

    return True

if __name__ == "__main__":
    success = test_special_chars()

    if success:
        print("\nâœ… ç‰¹æ®Šå­—ç¬¦æ–‡ä»¶æµ‹è¯•å®Œæˆï¼")
        print("ğŸ’¡ ç°åœ¨åº”è¯¥èƒ½å¤Ÿæ­£å¸¸åŠ è½½åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„æ–‡æ¡£äº†")
    else:
        print("\nâŒ æµ‹è¯•å¤±è´¥")